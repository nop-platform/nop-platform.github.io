<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="UTF-8">









  
  
  
    
  


  


  


  






  





  <title>Nop入门：动态SQL管理 - Nop</title>


  <meta property="og:title" content="Nop入门：动态SQL管理">


  <meta name="description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">
  <meta property="og:description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">



  
    
  


  <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程">


<!-- 页面渲染兼容性 -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- 订阅 -->

<meta name="theme-color" content="#0871ab">
<link rel="shortcut icon" href="/images/nop/logo.png">


    
<link rel="stylesheet" href="/stylesheets/global.css">

    
<link rel="stylesheet" href="/stylesheets/ksio/vendors/share.css">

<link rel="stylesheet" href="/local/syntax-highlighting.css">

<link rel="stylesheet" href="/stylesheets/pages/post.css">

<link rel="stylesheet" href="/stylesheets/pages/doc.css">

    
    
<script src="/javascripts/ksio/vendors/jquery-1.11.3.min.js"></script>

    
<script src="/javascripts/ksio/vendors/bootstrap.min.js"></script>

  </head>
  
  
  <body class="Page" itemscope itemtype="http://schema.org/WebPage">
    

  <header class="Page-header">
  <div class="navbar navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        
          <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse">
            <span class="sr-only">Toggle navs</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        
        
          


  <a class="navbar-brand" href="/">Nop</a>


        
      </div>
      <!-- Nav menus -->
      <nav class="Page-navs navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          
  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy/docs">指南</a>
</li>
  

  
    <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">文章</a>
</li>
  

  
    <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">视频</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy">Nop Entropy</a>
</li>
  

  
    <li><a href="/projects/nop-chaos">Nop Chaos</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/community">社区</a>
</li>
  

  
    <li><a href="/team">团队</a>
</li>
  

</ul>
    </li>
  


        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="Page-content">
  
  
    <aside class="Page-aside">
      <div class="AsideBrand">


  <a href="/">Nop</a>

</div>
      <nav class="AsideNav"><ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/why-nop/">介绍</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
        
        <a href="/projects/nop-entropy/docs/">文档概览</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">1. 极简服务层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">2. 极简数据访问层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/4-complex-query/">4. 复杂查询</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a class="is-selected" href="/projects/nop-entropy/docs/tutorial/simple/5-dynamic-sql/">5. 动态SQL管理</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/">软件架构</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/theory/">理论基础</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a>
      
      
    </li>
  
</ul>

      
    </li>
  
</ul>
</nav>
    </aside>
  
  <main class="Page-main">
    <article class="Article container-fluid">
      <header class="Article-header">
        
  
    <h1 class="Article-title">Nop入门：动态SQL管理</h1>
  
  


      </header>
      <div class="Article-content col-md-9"><p>Nop平台提供了类似MyBatis的动态SQL管理能力，但是功能特性远比MyBatis丰富、强大。同时它的实现反而更加简单，在NopORM的基础上实现SqlLibManager只需要300多行的代码。</p>
<p>讲解视频： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Xi421S7oG/">https://www.bilibili.com/video/BV1Xi421S7oG/</a></p>
<h2 id="一-使用说明"><a href="#一-使用说明" class="headerlink" title="一. 使用说明"></a>一. 使用说明</h2><h3 id="1-1-增加一个sql-lib-xml文件"><a href="#1-1-增加一个sql-lib-xml文件" class="headerlink" title="1.1 增加一个sql-lib.xml文件"></a>1.1 增加一个<code>sql-lib.xml</code>文件</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- /nop/demo/sql/demo.sql-lib.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span> <span class="hljs-attr">x:schema</span>=<span class="hljs-string">&quot;/nop/schema/orm/sql-lib.xdef&quot;</span> <span class="hljs-attr">xmlns:x</span>=<span class="hljs-string">&quot;/nop/schema/xdsl.xdef&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findFirstByName&quot;</span> <span class="hljs-attr">sqlMethod</span>=<span class="hljs-string">&quot;findFirst&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select o from DemoEntity o where o.name like $&#123;&#x27;%&#x27; + name + &#x27;%&#x27;&#125;<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br>    《<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>如果没有指定sqlMethod，则会根据SQL语句和是否传入range参数来自动推定。sqlMethod的可选值有findFirst&#x2F;findPage&#x2F;findAll&#x2F;execute等</li>
<li>通过<code>$&#123;expr&#125;</code>形式引入的表达式会被自动替换为SQL参数，并不是直接作为字符串拼接在一起。如果表达式返回的是集合对象，还会自动展开成一组参数。</li>
</ul>
<h3 id="1-2-增加一个Mapper类"><a href="#1-2-增加一个Mapper类" class="headerlink" title="1.2 增加一个Mapper类"></a>1.2 增加一个Mapper类</h3><p>通过<code>@SqlLibMapper</code>注解指定关联的<code>sql-lib.xml</code>文件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SqlLibMapper(&quot;/nop/demo/sql/demo.sql-lib.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DemoMapper</span> &#123;<br>  DemoEntity <span class="hljs-title function_">findFirstByName</span><span class="hljs-params">(<span class="hljs-meta">@Name(&quot;name&quot;)</span> String name)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-在beans-xml注册Mapper-Bean"><a href="#1-3-在beans-xml注册Mapper-Bean" class="headerlink" title="1.3 在beans.xml注册Mapper Bean"></a>1.3 在beans.xml注册Mapper Bean</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;io.nop.demo.biz.DemoMapper&quot;</span> </span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;io.nop.orm.sql_lib.proxy.SqlLibProxyFactoryBean&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">ioc:type</span>=<span class="hljs-string">&quot;@bean:id&quot;</span> <span class="hljs-attr">ioc:bean-method</span>=<span class="hljs-string">&quot;build&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperClass&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;@bean:type&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过Excel模型生成代码时，如果数据表具有mapper标签，则会自动生成Mapper接口类以及上述Mapper Bean的定义。</li>
</ul>
<table>
<thead>
<tr>
<th>MyBatis</th>
<th>Nop平台</th>
</tr>
</thead>
<tbody><tr>
<td>通过XML配置动态SQL</td>
<td>通过统一的Delta定制实现配置修正</td>
</tr>
<tr>
<td>通过Mapper接口封装SQL的执行</td>
<td>Nop平台使用统一的@Name注解定义参数名，通过IEvalContext来传递上下文对象</td>
</tr>
<tr>
<td>通过固定的几个标签函数生成动态SQL</td>
<td>Nop平台中通过Xpl标签库引入自定义标签</td>
</tr>
<tr>
<td>通过表达式生成SQL参数</td>
<td>表达式使用通用的表达式引擎，利用Xpl模板语言的SQL输出模式将输出的表达式结果转换为SQL参数</td>
</tr>
<tr>
<td>支持事务、结果数据缓存等</td>
<td>利用Dao层的JdbcTemplate，自动支持事务和结果缓存</td>
</tr>
<tr>
<td>管理SQL语句</td>
<td>同时管理EQL、SQL、DQL等各类查询语言</td>
</tr>
</tbody></table>
<h2 id="二-为什么使用XML文件是一种优点"><a href="#二-为什么使用XML文件是一种优点" class="headerlink" title="二. 为什么使用XML文件是一种优点"></a>二. 为什么使用XML文件是一种优点</h2><p>目前JPA和MyBatisPlus这种框架已经基本不使用XML配置格式，全部通过Java注解来实现配置。这导致很多人误以为XML格式已经完全过时，甚至看到使用XML格式的框架就会强烈反对。<br>但是这实际上是一种刻板印象和不正确的认知。</p>
<p>使用XML文件相比于注解存在很多好处。</p>
<h3 id="2-1-调试时不用停机就可以调整SQL语句"><a href="#2-1-调试时不用停机就可以调整SQL语句" class="headerlink" title="2.1 调试时不用停机就可以调整SQL语句"></a>2.1 调试时不用停机就可以调整SQL语句</h3><p>Nop平台中的所有模型文件都支持动态加载，只要修改模型文件，或者它所依赖的文件，模型解析缓存会自动更新。所以在调试时远比使用Java注解便捷</p>
<h3 id="2-2-通过Delta定制调整SQL语句"><a href="#2-2-通过Delta定制调整SQL语句" class="headerlink" title="2.2 通过Delta定制调整SQL语句"></a>2.2 通过Delta定制调整SQL语句</h3><p>当sql-lib模型文件已经打包到Jar包中之后，无需修改的原始xml文件，在独立的delta模块的delta目录下增加一个同名文件即可覆盖基础模块中的文件。</p>
<p>而使用Java注解的情况下，我们无法通过简单、通用的方式来定制jar包中的SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span> <span class="hljs-attr">x:extends</span>=<span class="hljs-string">&quot;super&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findUserRoles&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        ...<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>我们可以只定制指定的某个SQL语句，或者只定制某个指定属性。而在MyBatis中定制mapper文件的时候只能整体替换。</p>
<p>关于Delta定制的详细介绍，参见<a href="../../../dev-guide/delta/delta-customization/">delta-customization.md</a></p>
<h3 id="2-3-无代码开发可以在线调整SQL语句"><a href="#2-3-无代码开发可以在线调整SQL语句" class="headerlink" title="2.3 无代码开发可以在线调整SQL语句"></a>2.3 无代码开发可以在线调整SQL语句</h3><p>Nop平台中所有的模型文件统一使用虚拟文件系统进行管理，而虚拟文件系统可以将数据库中的某个配置表也当作虚拟文件来处理。通过这种方式，我们可以实现在界面上配置SQL语句，<br>而编程时可以将它看作是一个普通的sql-lib模型文件，并且复用Nop平台内置的模型缓存、模型依赖关系追踪等能力。</p>
<h3 id="2-4-二次抽象能力"><a href="#2-4-二次抽象能力" class="headerlink" title="2.4 二次抽象能力"></a>2.4 二次抽象能力</h3><p>Nop平台的模型文件加载时支持元编程处理，并且生成SQL语句时使用的XPL模板语言也支持自定义标签支持机制。这使得我们可以轻松发现SQL构造中的通用模式，并提供自定义的抽象。<br>比如说我们发现一个SQL片段经常出现，可以用自定义标签库将它抽象为一个函数，而使用Java注解，一般我们只能使用框架内置的抽象，没有进一步简化配置的可能性。</p>
<h3 id="2-5-基于元模型生成IDE提示和可视化设计器"><a href="#2-5-基于元模型生成IDE提示和可视化设计器" class="headerlink" title="2.5 基于元模型生成IDE提示和可视化设计器"></a>2.5 基于元模型生成IDE提示和可视化设计器</h3><p>MyBatis的IDE插件需要单独去编写。而在Nop平台中，任何DSL文件只要通过<code>x:schema</code>引入对应的元模型，通过通用的<code>nop-idea-plugin</code><br>插件即可自动推导得到语法提示、断点调试等功能。<br>类似的，可以根据元模型自动推导得到在线可视化设计器，直接设计对应的DSL文件。</p>
<h2 id="三-强大的XPL模板语言"><a href="#三-强大的XPL模板语言" class="headerlink" title="三. 强大的XPL模板语言"></a>三. 强大的XPL模板语言</h2><p>MyBatis的一个根本性设计问题在于它只提供了少数内置的标签，在实际使用过程中明显可以感觉到抽象能力不足。<br>在Nop平台中，我们使用XPL模板语言来生成SQL语句，可以通过XPL标签库来引入无限多的自定义抽象。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">x:config</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">c:import</span> <span class="hljs-attr">from</span>=<span class="hljs-string">&quot;/nop/orm/xlib/sql.xlib&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">x:config</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findWithDialect&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;product&quot;</span>/&gt;</span><br><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select<br>        <span class="hljs-tag">&lt;<span class="hljs-name">sql:fragment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;colList&quot;</span>/&gt;</span><br>        from my_entity<br>        where 1=1<br>        <span class="hljs-tag">&lt;<span class="hljs-name">sql:when-dialect</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;h2&quot;</span>&gt;</span><br>          and a = 1<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sql:when-dialect</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sql:filter</span>&gt;</span>and o.classId in (:ids)<span class="hljs-tag">&lt;/<span class="hljs-name">sql:filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">c:if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;$&#123;product.main&#125;&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">c:script</span>&gt;</span><br>            import app.MyHelper;<br>          <span class="hljs-tag">&lt;/<span class="hljs-name">c:script</span>&gt;</span><br>          and b &gt; $&#123;MyHelper.getXXX(product)&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">c:if</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>&lt;sql:fragment&gt;</code>和<code>&lt;sql:when-dialect&gt;</code>这样的标签都是<code>sql.xlib</code>标签库中自定义的标签，并不是引擎中内置的功能。</li>
<li>我们增加更多业务相关的标签，比如 <code>&lt;app:FilterTopProduct/&gt;</code>等。</li>
<li>XPL模板语言内置了<code>&lt;c:if&gt;</code>、<code>&lt;c:for&gt;</code>等大量语法结构，支持类似于JavaScript的表达式语法。可以直接通过<code>import</code>导入java类</li>
</ul>
<h2 id="三-面向OLAP的主子表查询"><a href="#三-面向OLAP的主子表查询" class="headerlink" title="三. 面向OLAP的主子表查询"></a>三. 面向OLAP的主子表查询</h2><p>润乾公司开源了一个<a target="_blank" rel="noopener" href="http://www.raqsoft.com.cn/r/os-bi">前端BI系统</a>，它在技术层面提出了一个别致的DQL(Dimentinal Query<br>Language)语言。具体介绍可以参考乾学院的文章</p>
<p><a target="_blank" rel="noopener" href="http://c.raqsoft.com.cn/article/1653901344139?p=1&m=0">告别宽表，用 DQL 成就新一代 BI - 乾学院</a></p>
<p>润乾的观点是终端用户难以理解复杂的SQL JOIN，为了便于多维分析，只能使用大宽表，这为数据准备带来一系列困难。而DQL则是简化了对终端用户而言JOIN操作的心智模型，并且在性能上相比于SQL更有优势。</p>
<p>例如，使用DQL可以简化主子表关联的汇总查询</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- SQL</span><br><span class="hljs-keyword">SELECT</span> T1.订单编号,T1.客户,<span class="hljs-built_in">SUM</span>(T2.价格)<br><span class="hljs-keyword">FROM</span> 订单表T1<br><span class="hljs-keyword">JOIN</span> 订单明细表T2 <span class="hljs-keyword">ON</span> T1.订单编号<span class="hljs-operator">=</span>T2.订单编号<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> T1.订单编号,T1.客户<br><br><span class="hljs-comment">-- DQL</span><br><span class="hljs-keyword">SELECT</span> 订单编号,客户,订单明细表.<span class="hljs-built_in">SUM</span>(价格)<br><span class="hljs-keyword">FROM</span> 订单表<br></code></pre></td></tr></table></figure>

<p>Nop平台通过QueryBean抽象实现了类似于DQL的这种组合查询能力</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findCustomStats&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">fields</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;orderNo&quot;</span>/&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;customer&quot;</span>/&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">owner</span>=<span class="hljs-string">&quot;orderDetails&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;price&quot;</span> <span class="hljs-attr">aggFunc</span>=<span class="hljs-string">&quot;sum&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">fields</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sourceName</span>&gt;</span>Order<span class="hljs-tag">&lt;/<span class="hljs-name">sourceName</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以在前端提供一个可视化设计器直接设计query对象。</p>
<p>在Java代码中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">QueryBean</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryBean</span>();<br>query.addFeld(mainField(<span class="hljs-string">&quot;orderNo&quot;</span>), mainField(<span class="hljs-string">&quot;customer&quot;</span>),<br>   subField(<span class="hljs-string">&quot;orderDetials&quot;</span>,<span class="hljs-string">&quot;price&quot;</span>).sum());<br>query.setSourceName(<span class="hljs-string">&quot;Order&quot;</span>);<br></code></pre></td></tr></table></figure>



<h2 id="四-更多MyBatis和JPA不具备的高级功能"><a href="#四-更多MyBatis和JPA不具备的高级功能" class="headerlink" title="四. 更多MyBatis和JPA不具备的高级功能"></a>四. 更多MyBatis和JPA不具备的高级功能</h2><h3 id="4-1-批量加载关联属性"><a href="#4-1-批量加载关联属性" class="headerlink" title="4.1 批量加载关联属性"></a>4.1 批量加载关联属性</h3><p>支持关联集合的ORM引擎很容易产生<code>N+1</code>问题，在<code>sql-lib</code>文件中可以配置batchLoadSelection实现类似GraphQL的批量加载机制，减少数据库访问次数。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findBySqlFilter&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">batchLoadSelection</span>&gt;</span><br>    simsCollege &#123; simsClasses &#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">batchLoadSelection</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>    select o<br>    from SimsClass o<br>    where 1=1<br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql:filter</span>&gt;</span>and o.classId in (:ids)<span class="hljs-tag">&lt;/<span class="hljs-name">sql:filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-启用数据权限过滤"><a href="#4-2-启用数据权限过滤" class="headerlink" title="4.2 启用数据权限过滤"></a>4.2 启用数据权限过滤</h3><p>开启enableFilter属性为true之后，会针对每个实体对象自动追加对应的数据权限过滤条件。如果结合NopORM引擎内置的IEqlAstTransformer机制，可以对EQL进行严格的格式检查和权限限制。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findFirstByName&quot;</span> <span class="hljs-attr">enableFilter</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">sqlMethod</span>=<span class="hljs-string">&quot;findFirst&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select u from NopAuthUser u where u.userName like $&#123;&#x27;%&#x27; + name + &#x27;%&#x27;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>一般情况下因为考虑到安全性问题，我们并不会把EQL语言的编辑权限开放给用户，但是借助于enableFilter和astTransformer机制，我们可以有效的限制用户使用EQL时访问的数据范围，杜绝SQL注入攻击。</p>
<h3 id="4-3-多数据源支持"><a href="#4-3-多数据源支持" class="headerlink" title="4.3 多数据源支持"></a>4.3 多数据源支持</h3><p>通过querySpace属性可以指定使用不同的DataSource，从而访问不同的数据库</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">querySpace</span>=<span class="hljs-string">&quot;report&quot;</span>&gt;</span><br>  ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在<code>beans.xml</code>中需要注册对应的DataSource, bean的id的格式为<code>nopDataSource_&#123;querySpace&#125;</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;nopDataSource_report&quot;</span>  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.zaxxer.hikari.HikariDataSource&quot;</span>&gt;</span><br>  ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-使用Native-SQL查询得到实体对象"><a href="#4-4-使用Native-SQL查询得到实体对象" class="headerlink" title="4.4 使用Native SQL查询得到实体对象"></a>4.4 使用Native SQL查询得到实体对象</h3><p>一般情况下我们使用<code>&lt;eql&gt;</code>节点来加载实体数据。但是如果设置rowType为实体类型，则也可以使用<code>&lt;sql&gt;</code>节点来加载实体数据。</p>
<p>返回结果包装为实体对象后，会自动提供关联属性延迟加载功能。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;testOrmEntityRowMapper&quot;</span> <span class="hljs-attr">rowType</span>=<span class="hljs-string">&quot;io.nop.app.SimsClass&quot;</span> <span class="hljs-attr">sqlMethod</span>=<span class="hljs-string">&quot;findFirst&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">colNameCamelCase</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select o.class_id, o.class_name, o.college_id<br>        from sims_class o<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>设置了colNameCamelCase会自动将<code>class_id</code>这样的返回字段名转换为<code>classId</code>这样的实体属性名</li>
<li>如果SQL语句返回的结果中没有包含主键字段，则会新建实体对象，否则会根据id加载当前OrmSession中的实体，并更新实体上的属性。</li>
<li>如果执行SQL之前对应的实体数据已经加载到内存中，且已经被修改，则执行SQL会抛出异常<code>nop.err.orm.entity-prop-is-dirty</code>。如果没有被修改，则会更新实体属性。</li>
<li>可以通过ormEntityRefreshBehavior来改变上面的行为。errorWhenDirty是缺省行为。useFirst将保留第一次加载的实体数据，忽略当前SQL查询得到的数据。useLast则使用最后一次查询得到的数据。</li>
</ul>
<p>更详细的介绍参见<a href="../../../dev-guide/orm/sql-lib/">sql-lib.md</a></p>
<h3 id="4-5-直接作为数据字典"><a href="#4-5-直接作为数据字典" class="headerlink" title="4.5 直接作为数据字典"></a>4.5 直接作为数据字典</h3><p>如果sql的名称以<code>_dict</code>为后缀，则可以通过DictProvider来调用它，获取到的结果被包装为DictBean对象。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">DictBean</span> dict = <span class="hljs-title class_">DictProvider</span>.<span class="hljs-title function_">instance</span>().<span class="hljs-title function_">getDict</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;sql/test.demo_dict&quot;</span>, <span class="hljs-literal">null</span>, scope);<br></code></pre></td></tr></table></figure>

<p>SQL语句要求必须包含value和label字段</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;demo_dict&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select o.collegeId as value, o.collegeName as label<br>        from SimsCollege o<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br></code></pre></td></tr></table></figure>
</div>
      <footer class="Article-footer col-md-3">
        
          
          
          
          
            
          
          
            <div class="Widget">
              <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/tutorial/simple/5-dynamic-sql.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div>
            </div>
          
        
        
  

  <section class="Widget Widget--toc">
  <div class="Widget-header">
    <h2 class="Widget-title">目录</h2>
  </div>
  <div class="Widget-body"></div>
</section>



      </footer>
    </article>
    <footer class="Page-footer Footer">
  <div class="container-fluid">
    
    <div class="Footer-description">
      
        <!-- Important links -->
        <nav class="Footer-navs">
          <ul><li><a href="/projects/nop-entropy/docs"><span>指南</span></a>
</li><li><a href="/community"><span>社区</span></a>
</li><li><a href="https://github.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow"><span>GitHub</span></a>
</li><li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow"><span>Gitee</span></a>
</li></ul>
        </nav>
      
      
        <!-- Copyright -->
        <div class="Footer-copyright">
          <p>

&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有

</p>
          
          
        </div>
      
    </div>
  </div>
</footer>

  </main>
</div>




    <script>$('.Article-content > table').addClass('table table-bordered')</script>
    
<script src="/javascripts/ksio/vendors/share.min.js"></script>

<script src="/javascripts/ksio/components/page.js"></script>

<script src="/javascripts/ksio/components/toc.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.zh-CN.js"></script>

<script src="/javascripts/ksio/initializers/time.js"></script>

<script src="/javascripts/ksio/vendors/jquery.lazyload.js"></script>

<script src="/javascripts/ksio/initializers/lazyload.js"></script>

  </body>
</html>

