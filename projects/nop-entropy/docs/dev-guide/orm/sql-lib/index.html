<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="UTF-8">









  
  
  
    
  


  


  


  






  





  <title>1  统一管理SQL&amp;#x2F;EQL&amp;#x2F;DQL - Nop</title>


  <meta property="og:title" content="1  统一管理SQL&amp;#x2F;EQL&amp;#x2F;DQL">


  <meta name="description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">
  <meta property="og:description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">



  
    
  


  <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程">


<!-- 页面渲染兼容性 -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- 订阅 -->

<meta name="theme-color" content="#0871ab">
<link rel="shortcut icon" href="/images/nop/logo.png">


    
<link rel="stylesheet" href="/stylesheets/global.css">

    
<link rel="stylesheet" href="/stylesheets/ksio/vendors/share.css">

<link rel="stylesheet" href="/local/syntax-highlighting.css">

<link rel="stylesheet" href="/stylesheets/pages/post.css">

<link rel="stylesheet" href="/stylesheets/pages/doc.css">

    
    
<script src="/javascripts/ksio/vendors/jquery-1.11.3.min.js"></script>

    
<script src="/javascripts/ksio/vendors/bootstrap.min.js"></script>

  </head>
  
  
  <body class="Page" itemscope itemtype="http://schema.org/WebPage">
    

  <header class="Page-header">
  <div class="navbar navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        
          <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse">
            <span class="sr-only">Toggle navs</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        
        
          


  <a class="navbar-brand" href="/">Nop</a>


        
      </div>
      <!-- Nav menus -->
      <nav class="Page-navs navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          
  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy/docs">指南</a>
</li>
  

  
    <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">文章</a>
</li>
  

  
    <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">视频</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy">Nop Entropy</a>
</li>
  

  
    <li><a href="/projects/nop-chaos">Nop Chaos</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/community">社区</a>
</li>
  

  
    <li><a href="/team">团队</a>
</li>
  

  
    <li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">Gitee 组织</a>
</li>
  

</ul>
    </li>
  

  
    <li><a href="https://nop-platform.github.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">English</a>
</li>
  


        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="Page-content">
  
  
    <aside class="Page-aside">
      <div class="AsideBrand">


  <a href="/">Nop</a>

</div>
      <nav class="AsideNav"><ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/why-nop/">介绍</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
        
        <a href="/projects/nop-entropy/docs/">文档概览</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">极简服务层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">极简数据访问层开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/">软件架构</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/theory/">理论基础</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a>
      
      
    </li>
  
</ul>

      
    </li>
  
</ul>
</nav>
    </aside>
  
  <main class="Page-main">
    <article class="Article container-fluid">
      <header class="Article-header">
        
  
    <h1 class="Article-title">1  统一管理SQL/EQL/DQL</h1>
  
  


      </header>
      <div class="Article-content col-md-9"><p>当我们需要构造比较复杂的SQL或者EQL语句的时候，通过一个外部模型文件对它们进行管理无疑是有着重要价值的。MyBatis提供了这样一种把SQL语句模型化的机制，但是仍然有很多人倾向于在Java代码中通过QueryDsl这样的方案来动态拼接SQL。这实际上是在说明<br><strong>MyBatis的功能实现比较单薄，没有能够充分发挥模型化的优势</strong>。</p>
<p>在NopOrm中，我们通过sql-lib模型来统一管理所有复杂的SQL&#x2F;EQL&#x2F;DQL语句。在利用Nop平台已有基础设施的情况下，实现类似MyBatis的这一SQL语句管理机制，大概只需要500行代码。具体实现代码参见</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-orm/src/main/java/io/nop/orm/sql_lib/SqlLibManager.java">SqlLibManager</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-orm/src/main/java/io/nop/orm/sql_lib/SqlItemModel.java">SqlItemModel</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-orm/src/main/java/io/nop/orm/sql_lib/proxy/SqlLibInvoker.java">SqlLibInvoker</a></p>
<p>测试用的sql-lib文件参见</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-orm/src/test/resources/_vfs/nop/test/sql/test.sql-lib.xml">test.sql-lib.xml</a></p>
<p>视频： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xX4y1e7Tv/">如何用500行代码实现类似MyBatis的功能</a></p>
<p>sql-lib提供了如下特性</p>
<p>在sql-lib文件中存在三种节点，sql&#x2F;eql&#x2F;query分别对应于SQL语句，EQL语句和上一节介绍的润乾DQL查询模型，对它们可以采取统一的方式进行管理。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xxx&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;yyy&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;zz&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>模型化的第一个好处就是Nop平台内置的Delta定制机制。假设我们已经开发了一个Base产品，在客户处部署的时候需要针对客户的数据情况进行SQL优化，则我们<br><strong>无需修改任何Base产品的代码</strong>，只需要添加一个sql-lib的差量化模型文件，就可以实现对任意SQL语句的定制。例如</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span> <span class="hljs-attr">x:extends</span>=<span class="hljs-string">&quot;raw:/original.sql-lib.xml&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 同名的sql语句会覆盖基类文件中的定义 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;yyy&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>关于Delta定制，另一个常见用法是结合元编程机制。假设我们的系统是一个领域模型很规整的系统，存在大量类似的SQL语句，则我们可以通过元编程机制先在编译期自动生成这些SQL语句，然后再通过Delta定制来对它们进行改进就可以了。例如</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql-lib</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">x:gen-extends</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">app:GenDefaultSqls</span></span><br><span class="hljs-tag">        <span class="hljs-attr">...</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">x:gen-extends</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sqls</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 在这里可以对自动生成SQL进行定制 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">”yyy“</span>&gt;</span>...<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sqls</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sql-lib</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="2-XPL模板的组件抽象能力"><a href="#2-XPL模板的组件抽象能力" class="headerlink" title="2. XPL模板的组件抽象能力"></a>2. XPL模板的组件抽象能力</h2><p>MyBatis只提供了foreach&#x2F;if&#x2F;include等少数几个固定标签，真正编写起高度复杂的动态SQL语句时可以说是有心无力。很多人觉得在xml中拼接sql比较麻烦，归根结底是因为MyBatis提供的是一个不完善的解决方案，它<br><strong>缺少二次抽象的机制</strong>。 而在java程序中我们总可以通过函数封装来实现对某一段SQL拼接逻辑的复用，对比MyBatis却只有内置的三板斧，基本没有提供任何辅助复用的能力。</p>
<p>NopOrm直接采用XLang语言中的XPL模板语言来作为底层的生成引擎，因此它自动继承了XPL模板语言的标签抽象能力。</p>
<blockquote>
<p>XLang是专为可逆计算理论而生的程序语言，它包含XDefinition&#x2F;XScript&#x2F;Xpl&#x2F;XTransform等多个部分，其核心设计思想是对抽象语法树AST的生成、转换和差量合并，可以认为它是针对Tree文法而设计的程序语言。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xxx&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select<br>        <span class="hljs-tag">&lt;<span class="hljs-name">my:MyFields</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">my:WhenAdmin</span>&gt;</span><br>            ,<br>            <span class="hljs-tag">&lt;<span class="hljs-name">my:AdmninFields</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">my:WhenAdmin</span>&gt;</span><br>        from MyEntity o<br>        where<br>        <span class="hljs-tag">&lt;<span class="hljs-name">my:AuthFilter</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>Xpl模板语言不仅内置了<code>&lt;c:for&gt;</code>,<code>&lt;c:if&gt;</code>等图灵完备语言所需的语法元素，而且允许通过自定制标签机制引入新的标签抽象（可以类比于前端的vue组件封装）。</p>
<p>有些模板语言要求所有能在模板中使用的函数需要提前注册，而Xpl模板语言可以直接调用Java。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">c:script</span>&gt;</span><br>            import test.MyService;<br><br>            let service = new MyService();<br>            let bean = inject(&quot;MyBean&quot;); // 直接获取IoC容器中注册的bean<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">c:script</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-宏-Macro-标签的元编程能力"><a href="#3-宏-Macro-标签的元编程能力" class="headerlink" title="3. 宏(Macro)标签的元编程能力"></a>3. 宏(Macro)标签的元编程能力</h3><p>MyBatis拼接动态SQL的方式很笨拙，因此一些类MyBatis的框架会在SQL模板层面提供一些特殊设计的简化语法。例如有些框架引入了隐式条件判断机制</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> xxx<br><span class="hljs-keyword">from</span> my_entity<br><span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> :id<br>[<span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span>:name]<br></code></pre></td></tr></table></figure>

<p>通过自动分析括号内的变量定义情况，自动增加一个隐式的条件判断，仅当name属性值不为空的时候才输出对应的SQL片段。</p>
<p>在NopOrm中，我们可以通过宏标签来实现类似的<strong>局部语法结构变换</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">sql</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select o from MyEntity o<br>        where 1=1<br>        <span class="hljs-tag">&lt;<span class="hljs-name">sql:filter</span>&gt;</span>and o.classId = :myVar<span class="hljs-tag">&lt;/<span class="hljs-name">sql:filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>&lt;sql:filter&gt;</code>是一个宏标签，它在编译期执行，相当于是对源码结构进行变换，等价于手写的如下代码</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">c:if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;$&#123;!_.isEmpty(myVar)&#125;&quot;</span>&gt;</span><br>    and o.classId = $&#123;myVar&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">c:if</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>具体标签的实现参见</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-orm/src/main/resources/_vfs/nop/orm/xlib/sql.xlib">sql.xlib</a></p>
<p>本质上这个概念等价于Lisp语言中的宏，特别是它与Lisp宏一样，可以用于程序代码中的任意部分（即AST的任意节点都可以被替换为宏节点）。只不过，它采用XML的表现形式，相比于Lisp惜字如金的数学符号风格而言，显得更加人性化一些。</p>
<p>微软C#语言的LINQ（语言集成查询）语法，其实现原理是在编译期获取到表达式的抽象语法树对象，然后交由应用代码执行结构变换，本质上也是一种编译期的宏变换技术。在XLang语言中，除了Xpl模板所提供的宏标签之外，还可以使用XScript的宏函数来实现SQL语法和对象语法之间的转换。例如</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">c:script</span>&gt;</span><br>    function f(x,y)&#123;<br>    return x + y;<br>    &#125;<br>    let obj = ...<br>    let &#123;a,b&#125; = linq `<br>    select sum(x + y) as a , sum(x * y) as b<br>    from obj<br>    where f(x,y) &gt; 2 and sin(x) &gt; cos(y)<br>    `<br><span class="hljs-tag">&lt;/<span class="hljs-name">c:script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>XScript的模板表达式会自动识别宏函数，并在编译期自动执行。因此我们可以定义一个宏函数linq，它将模板字符串在编译期解析为SQL语法树，然后再变换为普通的JavaScript<br>AST，从而相当于是在面向对象的XScript语法（类似TypeScript的脚本语言）中嵌入类SQL语法的DSL，可以完成类似LinQ的功能，但是实现方式要简单得多，形式上也更接近SQL的原始形式。</p>
<blockquote>
<p>以上仅为概念示例，目前Nop平台仅提供了xpath&#x2F;jpath&#x2F;xpl等宏函数，并没有提供内置的linq宏函数。</p>
</blockquote>
<h3 id="4-模板语言的SQL输出模式"><a href="#4-模板语言的SQL输出模式" class="headerlink" title="4. 模板语言的SQL输出模式"></a>4. 模板语言的SQL输出模式</h3><p>模板语言相对于普通程序语言而言，它的设计偏置是将输出（Output）这一副作用作为第一类（first<br>class）的概念。当我们没有做任何特殊修饰的时候，就表示对外输出，而如果我们要表示执行其他逻辑，则需要用表达式、标签等形式明确的隔离出来。Xpl模板语言作为一种Generic的模板语言，它对输出这一概念进行了强化，增加了多模式输出的设计。</p>
<p>Xpl模板语言支持多种输出模式（Output Mode）</p>
<ul>
<li><p>text: 普通文本的输出，不需要进行额外转义</p>
</li>
<li><p>xml: XML格式文本的输出，自动按照XML规范进行转义</p>
</li>
<li><p>node: 结构化AST的输出，会保留源码位置</p>
</li>
<li><p>sql：支持SQL对象的输出，杜绝SQL注入攻击</p>
</li>
</ul>
<p>sql模式针对SQL输出的情况做了特殊处理，主要增加了如下规则</p>
<ol>
<li><p>如果输出对象，则替换为?，并把对象收集到参数集合中。例如 <code>id = $&#123;id&#125;</code> 实际将生成id&#x3D;?的sql文本，同时通过一个List来保存参数值。</p>
</li>
<li><p>如果输出集合对象，则自动展开为多个参数。例如 <code>id in ($&#123;ids&#125;)</code> 对应生成id in (?,?,?)。</p>
</li>
</ol>
<p>如果确实希望直接输出SQL文本，拼接到SQL语句中，可以使用raw函数来包装。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">from MyEntity_$&#123;raw(postfix)&#125; o<br></code></pre></td></tr></table></figure>

<p>此外，NopOrm对于参数化SQL对象本身也建立了一个简单的包装模型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SQL = Text + Params<br></code></pre></td></tr></table></figure>

<p>通过sql &#x3D; SQL.begin().sql(“o.id &#x3D; ? “, name).end() 这种形式可以构造带参数的SQL语句对象。Xpl模板的sql输出模式会自动识别SQL对象，并自动对文本和参数集合分别进行处理。</p>
<h3 id="5-自动验证"><a href="#5-自动验证" class="headerlink" title="5. 自动验证"></a>5. 自动验证</h3><p>外部文件中管理SQL模板存在一个缺点：它无法依赖类型系统进行校验，只能期待运行时测试来检查SQL语法是否正确。如果数据模型发生变化，则可能无法立刻发现哪些SQL语句受到影响。<br>对于这个问题，其实存在一些比较简单的解决方案。毕竟，SQL语句既然已经作为结构化的模型被管理起来了，我们能够对它们进行操作的手段就变得异常丰富起来。<br>NopOrm内置了一个类似Contract Based<br>Programming的机制：每个EQL语句的模型都支持一个validate-input配置，我们可以在其中准备一些测试数据，然后ORM引擎在加载sql-lib的时候会自动运行validate-input得到测试数据，并以测试数据为基础执行SQL模板来生成EQL语句，然后交由EQL解析器来分析它的合法性，从而实现以一种准静态分析的方式检查ORM模型与EQL语句的一致性。</p>
<h3 id="6-调试支持"><a href="#6-调试支持" class="headerlink" title="6. 调试支持"></a>6. 调试支持</h3><p>与MyBatis内置的自制简易模板语言不同，NopOrm使用Xpl模板语言来生成SQL语句，因此可以很自然的可以利用XLang语言调试器来调试。Nop平台提供了IDEA开发插件，支持DSL语法提示和断点调试功能。它会自动读取sql-lib.xdef元模型定义文件，根据元模型自动校验sql-lib文件的语法正确性，并提供语法提示功能，支持在source段增加断点，进行单步调试等。</p>
<p>Nop平台中所有的DSL都是基于可逆计算原理构建的，它们都使用统一的元模型定义语言XDefinition来描述，所以并不需要针对每一种DSL来单独开发IDE插件和断点调试器。为了给自定义的sql-lib模型增加IDE支持，唯一需要的就是在模型根节点上增加属性x:<br>schema&#x3D;”&#x2F;nop&#x2F;schema&#x2F;orm&#x2F;sql-lib.xdef”，引入xdef元模型。</p>
<p>XLang语言还内置了一些调试特性，方便在元编程阶段对问题进行诊断。</p>
<ol>
<li><p>outputMode&#x3D;node输出模式下生成的AST节点会自动保留源文件的行号，因此当生成的代码编译报错时，我们直接对应到源文件的代码位置。</p>
</li>
<li><p>Xpl模板语言节点上可以增加xpl:dump属性，打印出当前节点经动态编译后得到的AST语法树</p>
</li>
<li><p>任何表达式都可以追加调用扩展函数<code>$</code>，它会自动打印当前表达式对应的文本、行号以及表达式执行的结果, 并返回表达式的结果值。例如</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">x = a.f().$(prefix) 实际对应于<br>x = DebugHelper.v(location,prefix, &quot;a.f()&quot;,a.f())<br></code></pre></td></tr></table></figure>

<h3 id="7-根据Dialect生成对应的SQL语句"><a href="#7-根据Dialect生成对应的SQL语句" class="headerlink" title="7. 根据Dialect生成对应的SQL语句"></a>7. 根据Dialect生成对应的SQL语句</h3><p>利用标签库可以引入各种自定义的扩展逻辑。比如根据不同的数据库方言生成不同的SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">select<br><span class="hljs-tag">&lt;<span class="hljs-name">sql:when-dialect</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;h2&quot;</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">sql:when-dialect</span>&gt;</span><br>        from my_entity<br></code></pre></td></tr></table></figure>

<h3 id="8-Mapper接口"><a href="#8-Mapper接口" class="headerlink" title="8. Mapper接口"></a>8. Mapper接口</h3><p>只要在Excel数据模型中为实体增加mapper标签，代码生成的时候就会自动生成类似MyBatis的强类型的Mapper接口，通过它可以调用SqlLibManager所管理的SQL模型文件。例如<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-app-mall/blob/master/app-mall-dao/src/main/java/app/mall/dao/mapper/LitemallGoodsMapper.java">LitemallGoodsMapper.java</a>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@SqlLibMapper(&quot;/app/mall/sql/LitemallGoods.sql-lib.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LitemallGoodsMapper</span> &#123;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncCartProduct</span><span class="hljs-params">(<span class="hljs-meta">@Name(&quot;product&quot;)</span> LitemallGoodsProduct product)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过SqlLibMapper注解可以指定当前接口所关联的SQL模型文件。</p>
<h2 id="与MyBatis的对比"><a href="#与MyBatis的对比" class="headerlink" title="与MyBatis的对比"></a>与MyBatis的对比</h2><table>
<thead>
<tr>
<th>MyBatis</th>
<th>Nop平台</th>
</tr>
</thead>
<tbody><tr>
<td>通过XML配置动态SQL</td>
<td>通过统一的Delta定制实现配置修正</td>
</tr>
<tr>
<td>通过Mapper接口封装SQL的执行</td>
<td>Nop平台使用统一的@Name注解定义参数名，通过IEvalContext来传递上下文对象</td>
</tr>
<tr>
<td>通过标签函数生成动态SQL</td>
<td>Nop平台中通过Xpl标签库引入自定义标签</td>
</tr>
<tr>
<td>通过表达式生成SQL参数</td>
<td>表达式使用通用的表达式引擎，利用Xpl模板语言的SQL输出模式将输出的表达式结果转换为SQL参数</td>
</tr>
<tr>
<td>支持事务、结果数据缓存等</td>
<td>利用Dao层的JdbcTemplate，自动支持事务和结果缓存</td>
</tr>
<tr>
<td>管理SQL语句</td>
<td>同时管理EQL、SQL、DQL等各类查询语言</td>
</tr>
</tbody></table>
<p>利用Nop平台的内置机制，还可以自动支持如下功能：</p>
<ol>
<li><p>多数据源、多租户、分库分表</p>
</li>
<li><p>将SQL语句直接暴露为前台可访问的字典表，此时字典表名称格式为sql&#x2F;{sqlName}</p>
</li>
<li><p>使用EQL查询语言时支持批量属性加载，在获取到结果数据之后，可以直接指定加载结果数据中的关联属性。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;findActiveTasks&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">batchLoadSelection</span>&gt;</span><br>        relatedEntity&#123; myProp &#125;, myParent&#123; children &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">batchLoadSelection</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select o from MyEntity o where o.status = 1<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="扩展配置"><a href="#扩展配置" class="headerlink" title="扩展配置"></a>扩展配置</h2><h3 id="enableFilter属性设置为true，将会启用数据权限过滤"><a href="#enableFilter属性设置为true，将会启用数据权限过滤" class="headerlink" title="enableFilter属性设置为true，将会启用数据权限过滤"></a>enableFilter属性设置为true，将会启用数据权限过滤</h3><p>OrmSessionFactory支持IEntityFilterProvider配置，nop-auth-service模块提供的缺省实现对应于数据权限过滤</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">eql</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xxx&quot;</span> <span class="hljs-attr">enableFilter</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span><br>        select u.xx from MyEntity u, OtherEntity t where u.fldA = t.fldA<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">eql</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>也可以使用在构造SQL对象时直接指定enableFilter属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span> sql = <span class="hljs-variable constant_">SQL</span>.<span class="hljs-title function_">begin</span>().<span class="hljs-title function_">enableFilter</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_">sql</span>(<span class="hljs-string">&quot;...&quot;</span>).<span class="hljs-title function_">end</span>();<br></code></pre></td></tr></table></figure>

<p>启用enableFilter后，会自动利用<code>IServiceContext.bindingCtx()</code>获取当前上下文中的IServiceContext，并调用<code>IDataAuthChecker.getFilter()</code><br>来获取到数据权限过滤条件，转换为SQL语句后拼接到原始的SQL语句中。</p>
<blockquote>
<p>如果允许用户直接编写SQL语句，则可以利用enableFilter特性来自动追加数据权限过滤条件，避免产生数据泄露</p>
</blockquote>
<h3 id="allowUnderscoreName设置为true，将会允许在EQL中直接使用数据库字段名"><a href="#allowUnderscoreName设置为true，将会允许在EQL中直接使用数据库字段名" class="headerlink" title="allowUnderscoreName设置为true，将会允许在EQL中直接使用数据库字段名"></a>allowUnderscoreName设置为true，将会允许在EQL中直接使用数据库字段名</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;eql name=&quot;xx&quot; allowUnderscoreName=&quot;true&quot;&gt;<br>  &lt;source&gt;<br>     select o.statusId, o.status_id from MyEntity o<br>  &lt;/source&gt;<br>&lt;/eql&gt;<br></code></pre></td></tr></table></figure>

<p>使用statusId或者status_id都可以访问实体上的属性。</p>
<p>也可以使用在构造SQL对象时直接指定allowUnderscoreName属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable constant_">SQL</span>.<span class="hljs-title function_">begin</span>().<span class="hljs-title function_">allowUnderscoreName</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_">sql</span>(<span class="hljs-string">&quot;....&quot;</span>).<span class="hljs-title function_">end</span>();<br></code></pre></td></tr></table></figure>
</div>
      <footer class="Article-footer col-md-3">
        
          
          
          
          
            
          
          
            <div class="Widget">
              <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/orm/sql-lib.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div>
            </div>
          
        
        
  

  <section class="Widget Widget--toc">
  <div class="Widget-header">
    <h2 class="Widget-title">目录</h2>
  </div>
  <div class="Widget-body"></div>
</section>



      </footer>
    </article>
    <footer class="Page-footer Footer">
  <div class="container-fluid">
    
    <div class="Footer-description">
      
        <!-- Important links -->
        <nav class="Footer-navs">
          <ul><li><a href="/projects/nop-entropy/docs"><span>指南</span></a>
</li><li><a href="/community"><span>社区</span></a>
</li></ul>
        </nav>
      
      
        <!-- Copyright -->
        <div class="Footer-copyright">
          <p>

&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有

</p>
          
          
        </div>
      
    </div>
  </div>
</footer>

  </main>
</div>




    <script>$('.Article-content > table').addClass('table table-bordered')</script>
    
<script src="/javascripts/ksio/vendors/share.min.js"></script>

<script src="/javascripts/ksio/components/page.js"></script>

<script src="/javascripts/ksio/components/toc.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.zh-CN.js"></script>

<script src="/javascripts/ksio/initializers/time.js"></script>

<script src="/javascripts/ksio/vendors/jquery.lazyload.js"></script>

<script src="/javascripts/ksio/initializers/lazyload.js"></script>

  </body>
</html>

