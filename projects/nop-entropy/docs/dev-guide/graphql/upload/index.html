<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="UTF-8">









  
  
  
    
  


  


  


  






  





  <title>GraphQL引擎的上传下载扩展 - Nop</title>


  <meta property="og:title" content="GraphQL引擎的上传下载扩展">


  <meta name="description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">
  <meta property="og:description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">



  
    
  


  <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程">


<!-- 页面渲染兼容性 -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- 订阅 -->

<meta name="theme-color" content="#0871ab">
<link rel="shortcut icon" href="/images/nop/logo.png">


    
<link rel="stylesheet" href="/stylesheets/global.css">

    
<link rel="stylesheet" href="/stylesheets/ksio/vendors/share.css">

<link rel="stylesheet" href="/local/syntax-highlighting.css">

<link rel="stylesheet" href="/stylesheets/pages/post.css">

<link rel="stylesheet" href="/stylesheets/pages/doc.css">

    
    
<script src="/javascripts/ksio/vendors/jquery-1.11.3.min.js"></script>

    
<script src="/javascripts/ksio/vendors/bootstrap.min.js"></script>

  </head>
  
  
  <body class="Page" itemscope itemtype="http://schema.org/WebPage">
    

  <header class="Page-header">
  <div class="navbar navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        
          <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse">
            <span class="sr-only">Toggle navs</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        
        
          


  <a class="navbar-brand" href="/">Nop</a>


        
      </div>
      <!-- Nav menus -->
      <nav class="Page-navs navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          
  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy/docs">指南</a>
</li>
  

  
    <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">文章</a>
</li>
  

  
    <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">视频</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy">Nop Entropy</a>
</li>
  

  
    <li><a href="/projects/nop-chaos">Nop Chaos</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/community">社区</a>
</li>
  

  
    <li><a href="/team">团队</a>
</li>
  

</ul>
    </li>
  


        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="Page-content">
  
  
    <aside class="Page-aside">
      <div class="AsideBrand">


  <a href="/">Nop</a>

</div>
      <nav class="AsideNav"><ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/why-nop/">介绍</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
        
        <a href="/projects/nop-entropy/docs/">文档概览</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">1. 极简服务层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">2. 极简数据访问层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/4-complex-query/">4. 复杂查询</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/5-dynamic-sql/">5. 动态SQL管理</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/">软件架构</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/theory/">理论基础</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a>
      
      
    </li>
  
</ul>

      
    </li>
  
</ul>
</nav>
    </aside>
  
  <main class="Page-main">
    <article class="Article container-fluid">
      <header class="Article-header">
        
  
    <h1 class="Article-title">GraphQL引擎的上传下载扩展</h1>
  
  


      </header>
      <div class="Article-content col-md-9"><p>标准的GraphQL引擎只支持JSON格式的输入输出。为了支持文件上传下载，NopGraphQL在接口层增加了一些扩展约定。</p>
<ol>
<li>文件上传信息被转换为UploadRequestBean对象，在GraphQL引擎内部只要针对UploadRequestBean进行编程即可。相当于是在JSON序列化协议的基础上增加一个自动的针对上传文件的序列化机制。<br>目前缺省情况下&#x2F;f&#x2F;upload这个端点会自动解析上传文件并调用GraphQL引擎。</li>
<li>GraphQL引擎可以返回WebContentBean来表示下载资源文件。Web框架调用GraphQL引擎发现返回结果是WebContentBean之后，会自动从中读取到Resource对象，并设置Content-Type和Content-Disposition等header配置。<br>目前缺省情况下&#x2F;p&#x2F;{bizObjName}__{bizAction}以及&#x2F;f&#x2F;download&#x2F;{fileId}这两种调用形式会自动识别WebContentBean</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@BizModel(&quot;NopFileStore&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NopFileStoreBizModel</span> &#123;<br>    ...<br>    <span class="hljs-meta">@BizMutation</span><br>    <span class="hljs-keyword">public</span> UploadResponseBean <span class="hljs-title function_">upload</span><span class="hljs-params">(<span class="hljs-meta">@RequestBean</span> UploadRequestBean record, IServiceContext context)</span> &#123;<br>        checkMaxSize(record.getLength());<br>        checkFileExt(record.getFileExt());<br>        checkBizObjName(record.getBizObjName());<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileId</span> <span class="hljs-operator">=</span> fileStore.saveFile(record, maxFileSize);<br><br>        <span class="hljs-type">UploadResponseBean</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadResponseBean</span>();<br>        ret.setValue(fileStore.getFileLink(fileId));<br>        ret.setFilename(record.getFileName());<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    <span class="hljs-meta">@BizQuery</span><br>    <span class="hljs-keyword">public</span> WebContentBean <span class="hljs-title function_">download</span><span class="hljs-params">(<span class="hljs-meta">@Name(&quot;fileId&quot;)</span> String fileId,</span><br><span class="hljs-params">                                   <span class="hljs-meta">@Name(&quot;contentType&quot;)</span> String contentType)</span> &#123;<br>        <span class="hljs-type">IFileRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> fileStore.getFile(fileId);<br>        <span class="hljs-keyword">if</span> (StringHelper.isEmpty(contentType))<br>            contentType = MediaType.APPLICATION_OCTET_STREAM;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebContentBean</span>(contentType, record.getResource(), record.getFileName());<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> IFileRecord <span class="hljs-title function_">loadFileRecord</span><span class="hljs-params">(String fileId, IServiceContext ctx)</span> &#123;<br>        <span class="hljs-type">IFileRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> fileStore.getFile(fileId);<br>        <span class="hljs-keyword">if</span> (bizAuthChecker != <span class="hljs-literal">null</span>) &#123;<br>            bizAuthChecker.checkAuth(record.getBizObjName(), record.getBizObjId(), record.getFieldName(), ctx);<br>        &#125;<br>        <span class="hljs-keyword">return</span> record;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>NopFileStoreBizModel只是针对POJO对象进行编程，它完全不需要具有任何关于特定Web框架的知识，因此我们可以将它适配到不同的Web框架。例如，对于SpringMVC，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringFileService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractGraphQLFileService</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/f/upload&quot;)</span><br>    <span class="hljs-keyword">public</span> CompletionStage&lt;ResponseEntity&lt;Object&gt;&gt; <span class="hljs-title function_">upload</span><span class="hljs-params">(MultipartFile file, HttpServletRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">locale</span> <span class="hljs-operator">=</span> ContextProvider.currentLocale();<br>        CompletionStage&lt;ApiResponse&lt;?&gt;&gt; res;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> file.getInputStream();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> StringHelper.fileFullName(file.getOriginalFilename());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> MediaTypeHelper.getMimeType(file.getContentType(), StringHelper.fileExt(fileName));<br>            <span class="hljs-type">UploadRequestBean</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadRequestBean</span>(is, fileName, file.getSize(), mimeType);<br>            input.setBizObjName(request.getParameter(FileConstants.PARAM_BIZ_OBJ_NAME));<br><br>            <span class="hljs-type">IGraphQLEngine</span> <span class="hljs-variable">graphQLEngine</span> <span class="hljs-operator">=</span> getGraphQLEngine();<br><br>            <span class="hljs-type">IGraphQLExecutionContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> graphQLEngine.newRpcContext(GraphQLOperationType.mutation,<br>                    <span class="hljs-string">&quot;NopFileStore__upload&quot;</span>, buildApiRequest(request,input));<br>            res = graphQLEngine.executeRpcAsync(ctx);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            res = FutureHelper.success(ErrorMessageManager.instance().buildResponse(locale, e));<br>        &#125;<br>        <span class="hljs-keyword">return</span> res.thenApply(response -&gt; SpringWebHelper.buildResponse(response.getHttpStatus(), response));<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> &lt;T&gt; ApiRequest&lt;T&gt; <span class="hljs-title function_">buildApiRequest</span><span class="hljs-params">(HttpServletRequest req, T data)</span> &#123;<br>        ApiRequest&lt;T&gt; ret = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiRequest</span>&lt;&gt;();<br>        Enumeration&lt;String&gt; it = req.getHeaderNames();<br>        <span class="hljs-keyword">while</span> (it.hasMoreElements()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> it.nextElement();<br>            name = name.toLowerCase(Locale.ENGLISH);<br>            <span class="hljs-keyword">if</span> (shouldIgnoreHeader(name))<br>                <span class="hljs-keyword">continue</span>;<br>            ret.setHeader(name, req.getHeader(name));<br>        &#125;<br>        ret.setData(data);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="模块依赖"><a href="#模块依赖" class="headerlink" title="模块依赖"></a>模块依赖</h2><p>引入nop-quarkus-web-orm-starter或者nop-spring-web-orm-starter依赖后，会自动引入</p>
<ul>
<li>nop-file-dao： 包含文件上传下载服务NopFileStoreBizModel的实现</li>
<li>nop-file-spring或者 nop-file-quarkus: 引入处理&#x2F;f&#x2F;upload和&#x2F;f&#x2F;download链接的REST服务</li>
</ul>
<p><strong>使用oss云存储支持时需要引入nop-integration-oss模块</strong></p>
<ul>
<li>nop-integration-oss: 包含AmazonS3对象存储支持，阿里云OSS，腾讯云COS，七牛云，京东云，minio都支持这一接口标准。</li>
</ul>
<p>nop-integration-oss目前是可选模块，使用云存储来保存附件时需要自行引入这个模块。</p>
<h2 id="实体字段支持附件类型"><a href="#实体字段支持附件类型" class="headerlink" title="实体字段支持附件类型"></a>实体字段支持附件类型</h2><p>NopORM并没有内置对于附件字段的支持，在应用层我们通过OrmFileComponent这种字段级别的抽象将文件存储与数据库存储结合在一起。</p>
<ol>
<li>附件字段中保存文件下载链接</li>
<li>在数据库中插入NopFileRecord保存附件的大小、文件名、Hash值等元数据，同时保存fileId和实体之间的关联关系，下载文件时可以验证是否具有实体访问权限</li>
<li>通过IFileStore接口保存具体的二进制文件数据。Nop平台中内置了本地文件存储以及AmazonS3对象存储支持，支持Minio、七牛云、腾讯云、阿里云等兼容S3的云存储。</li>
</ol>
<h2 id="Excel数据模型"><a href="#Excel数据模型" class="headerlink" title="Excel数据模型"></a>Excel数据模型</h2><p>在Excel数据模型中为字段的domain指定stdDomain&#x3D;file，表示它保存上传文件的链接地址。</p>
<p><img src="/knosys/project-nop-entropy/dev-guide/graphql/file-domain.png"><br><img src="/knosys/project-nop-entropy/dev-guide/graphql/field-domain.png"></p>
<p>根据Excel模型生成orm.xml模型文件中会为字段生成stdDomain配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">orm</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">x:post-extends</span> <span class="hljs-attr">x:override</span>=<span class="hljs-string">&quot;replace&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">orm-gen:DefaultPostExtends</span> <span class="hljs-attr">xpl:lib</span>=<span class="hljs-string">&quot;/nop/orm/xlib/orm-gen.xlib&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">x:post-extends</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entites</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">entity</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;io.nop.auth.dao.entity.NopAuthUser&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">columns</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">code</span>=<span class="hljs-string">&quot;AVATAR&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;头像&quot;</span> <span class="hljs-attr">domain</span>=<span class="hljs-string">&quot;image&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;avatar&quot;</span> <span class="hljs-attr">precision</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attr">propId</span>=<span class="hljs-string">&quot;9&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">stdDataType</span>=<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-attr">stdDomain</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">stdSqlType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span> <span class="hljs-attr">i18n-en:displayName</span>=<span class="hljs-string">&quot;Avatar&quot;</span></span><br><span class="hljs-tag">                        <span class="hljs-attr">ui:show</span>=<span class="hljs-string">&quot;X&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">columns</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">entity</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entites</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">orm</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在编译期执行的<code>x:post-extends</code>段会执行标签函数 <code>&lt;orm-gen:FileComponentSupport/&gt;</code>，它会为每个文件链接字段生成一个对应的OrmFileComponent属性。</p>
<h2 id="OrmFileComponent实现文件与实体的绑定"><a href="#OrmFileComponent实现文件与实体的绑定" class="headerlink" title="OrmFileComponent实现文件与实体的绑定"></a>OrmFileComponent实现文件与实体的绑定</h2><p>上传文件会将具体文件数据保存到IFileStore中，同时会在数据库中插入NopFileRecord记录，用于保存文件名、文件大小等描述信息。</p>
<p>当实体更新或者删除的时候，会触发IOrmComponent接口上的onEntityFlush和onEntityDelete回调函数，在回调函数中将更新NopFileRecord对象上的bizObjName,bizObjId属性。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrmFileComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractOrmComponent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROP_NAME_filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;filePath&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFilePath</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> ConvertHelper.toString(internalGetPropValue(PROP_NAME_filePath));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFilePath</span><span class="hljs-params">(String value)</span> &#123;<br>        internalSetPropValue(PROP_NAME_filePath, value);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEntityFlush</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">IOrmEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> orm_owner();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">propId</span> <span class="hljs-operator">=</span> getColPropId(PROP_NAME_filePath);<br>        <span class="hljs-keyword">if</span> (entity.orm_state().isUnsaved() || entity.orm_propDirty(propId)) &#123;<br>            <span class="hljs-type">IBeanProvider</span> <span class="hljs-variable">beanProvider</span> <span class="hljs-operator">=</span> entity.orm_enhancer().getBeanProvider();<br>            <span class="hljs-type">IOrmEntityFileStore</span> <span class="hljs-variable">fileStore</span> <span class="hljs-operator">=</span> (IOrmEntityFileStore) beanProvider.getBean(OrmConstants.BEAN_ORM_ENTITY_FILE_STORE);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> (String) entity.orm_propOldValue(propId);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileId</span> <span class="hljs-operator">=</span> fileStore.decodeFileId(getFilePath());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">propName</span> <span class="hljs-operator">=</span> entity.orm_propName(propId);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">bizObjName</span> <span class="hljs-operator">=</span> getBizObjName();<br><br>            <span class="hljs-keyword">if</span> (!StringHelper.isEmpty(oldValue)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">oldFileId</span> <span class="hljs-operator">=</span> fileStore.decodeFileId(oldValue);<br>                <span class="hljs-keyword">if</span> (!StringHelper.isEmpty(oldFileId)) &#123;<br>                    fileStore.detachFile(oldFileId, bizObjName, entity.orm_idString(), propName);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!StringHelper.isEmpty(fileId)) &#123;<br>                fileStore.attachFile(fileId, bizObjName, entity.orm_idString(), propName);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里很重要的一个设计就是实体层面上记录了附件字段是否已经被修改，以及修改前的值。可以想见，如果没有这种历史记录信息，我们就无法在单个字段层面确定如何实现文件存储与实体字段的同步，<br>而必须上升到整个实体的处理函数中进行。</p>
<h2 id="后台读取"><a href="#后台读取" class="headerlink" title="后台读取"></a>后台读取</h2><p>通过<code>/f/upload</code>上传的文件在后台可以直接读取到</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"> <span class="hljs-title class_">IOrmEntityFileStore</span> fileStore = ...;<br><span class="hljs-title class_">String</span> fileId = fileStore.<span class="hljs-title function_">decodeFileId</span>(importFilePath);<br><span class="hljs-comment">// 总是处理上传的临时文件</span><br><span class="hljs-title class_">String</span> objId = <span class="hljs-title class_">FileConstants</span>.<span class="hljs-property">TEMP_BIZ_OBJ_ID</span>;<br><span class="hljs-title class_">IResource</span> resource = fileStore.<span class="hljs-title function_">getFileResource</span>(fileId, <span class="hljs-title function_">getBizObjName</span>(), objId, <span class="hljs-title class_">NopRuleConstants</span>.<span class="hljs-property">PROP_IMPORT_FILE</span>);<br><br></code></pre></td></tr></table></figure>
<p>通过IOrmEntityFileStore接口可以读取。</p>
<p>如果是使用<code>domain=file</code>实现的附件字段，则</p>
<h2 id="前端控件"><a href="#前端控件" class="headerlink" title="前端控件"></a>前端控件</h2><p>在control.xlib标签库中，根据stdDomain设置会自动为字段选择对应的编辑和显示控件。</p>
<p><code>&lt;edit-file&gt;</code>控件缺省会上传文件到&#x2F;f&#x2F;upload这个链接，返回的数据格式为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;<br>  status:0,<br>  data:&#123;<br>     value: &quot;文件下载链接&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下载链接的格式为 &#x2F;f&#x2F;download&#x2F;{fileId}</p>
<p>在meta的prop节点上，可以配置以下属性:</p>
<ul>
<li>ui:maxUploadSize 控制上传文件的最大大小</li>
<li>ui:uploadUrl 定制上传文件端点</li>
<li>ui:accept 可以控制允许的文件后缀，例如 .txt,.md表示只允许上传txt和markddown文件</li>
</ul>
<p>另外也可以通过全局配置来设置上传控件属性</p>
<ul>
<li>nop.file.upload-url 全局指定的上传文件端点，缺省为&#x2F;f&#x2F;upload</li>
<li>nop.file.upload.max-size 全局指定的上传文件大小限制。每个prop上指定的ui:maxUploadSize不能超过这个值，实际起作用的是min(prop.uploadFileSize,global.uploadMaxSize)</li>
</ul>
<h2 id="集成Minio"><a href="#集成Minio" class="headerlink" title="集成Minio"></a>集成Minio</h2><p>很多分布式存储都兼容Amazon的S3存储协议，例如阿里云OSS，腾讯云COS，七牛云，京东云，Minio等。</p>
<p>使用如下配置启用Minio支持。<strong>注意，使用oss云存储支持时需要先引入nop-integration-oss模块</strong>。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">nop:</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">store-impl:</span> <span class="hljs-string">oss</span><br><br>  <span class="hljs-attr">integration:</span><br>    <span class="hljs-attr">oss:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://localhost:9000</span><br>      <span class="hljs-comment">#default-bucket-name: nop-file</span><br>      <span class="hljs-attr">access-key:</span> <span class="hljs-string">xxx</span><br>      <span class="hljs-attr">secret-key:</span> <span class="hljs-string">yyy</span><br>      <span class="hljs-comment">#path-style-access: false</span><br></code></pre></td></tr></table></figure>

<ul>
<li>nop.file.store-impl指定为oss时会使用对象存储来保存文件，否则会使用本地文件系统，存放在&#x2F;nop&#x2F;file目录下</li>
<li>阿里云要求pathStyleAccess必须设置为false</li>
</ul>
<p><strong>注意: 配置项是nop.integration.oss.enabled，而不是nop.file.integration.oss.enabled</strong></p>
<h2 id="前端显示"><a href="#前端显示" class="headerlink" title="前端显示"></a>前端显示</h2><p>如果excel数据模型中设置了<code>domain=file</code>或者<code>domain=file-list</code>，则XMeta中会自动生成对应FileStatus属性，例如NopAuthUser中的avatar字段对应生成<code>avatarComponentFileStatus</code>。</p>
<p>FileStatus会返回文件的名称、大小等信息。</p>
<p><code>control.xlib</code>中的<code>&lt;view-file&gt;</code>用于在前台显示文件下载链接，它会使用FileStatus中的信息来获取文件名等。</p>
<h2 id="文件共享"><a href="#文件共享" class="headerlink" title="文件共享"></a>文件共享</h2><p>IOrmEntityFileStore提供了copyFile函数，可以根据指定fileId复制一份NopFileRecord记录，从而允许多个附件字段复用同一个文件存储。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">String</span> <span class="hljs-title function_">copyFile</span>(<span class="hljs-title class_">String</span> fileId, <span class="hljs-title class_">String</span> newBizObjName, <span class="hljs-title class_">String</span> newObjId, <span class="hljs-title class_">String</span> newFieldName);<br></code></pre></td></tr></table></figure>

<ul>
<li>copyFile返回一个新的fileId</li>
<li>在NopFileRecord记录上增加了originFileId字段，从同一个NopFileRecord复制得到的记录都具有同样的originFileId值。</li>
<li>detachFile的时候会检查当前记录是否是最后一个共享originFileId的记录。如果是，则也删除文件存储中的文件，否则只删除对应的NopFileRecord。</li>
</ul>
<h2 id="配置变量"><a href="#配置变量" class="headerlink" title="配置变量"></a>配置变量</h2><ul>
<li>nop.file.store-dir<br>使用本地文件系统存储上传文件时使用的目录，缺省为&#x2F;nop&#x2F;file</li>
<li>nop.file.store-impl<br>如果设置为oss则表示启用分布式存储，否则使用本地存储</li>
<li>nop.file.upload-url 全局指定的上传文件端点，缺省为&#x2F;f&#x2F;upload</li>
<li>nop.file.upload.max-size 全局指定的上传文件大小限制。每个prop上指定的ui:maxUploadSize不能超过这个值，实际起作用的是min(prop.uploadFileSize,global.uploadMaxSize)</li>
</ul>

</div>
      <footer class="Article-footer col-md-3">
        
          
          
          
          
            
          
          
            <div class="Widget">
              <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/graphql/upload.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div>
            </div>
          
        
        
  

  <section class="Widget Widget--toc">
  <div class="Widget-header">
    <h2 class="Widget-title">目录</h2>
  </div>
  <div class="Widget-body"></div>
</section>



      </footer>
    </article>
    <footer class="Page-footer Footer">
  <div class="container-fluid">
    
    <div class="Footer-description">
      
        <!-- Important links -->
        <nav class="Footer-navs">
          <ul><li><a href="/projects/nop-entropy/docs"><span>指南</span></a>
</li><li><a href="/community"><span>社区</span></a>
</li><li><a href="https://github.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow"><span>GitHub</span></a>
</li><li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow"><span>Gitee</span></a>
</li></ul>
        </nav>
      
      
        <!-- Copyright -->
        <div class="Footer-copyright">
          <p>

&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有

</p>
          
          
        </div>
      
    </div>
  </div>
</footer>

  </main>
</div>




    <script>$('.Article-content > table').addClass('table table-bordered')</script>
    
<script src="/javascripts/ksio/vendors/share.min.js"></script>

<script src="/javascripts/ksio/components/page.js"></script>

<script src="/javascripts/ksio/components/toc.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.zh-CN.js"></script>

<script src="/javascripts/ksio/initializers/time.js"></script>

<script src="/javascripts/ksio/vendors/jquery.lazyload.js"></script>

<script src="/javascripts/ksio/initializers/lazyload.js"></script>

  </body>
</html>

