<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="UTF-8">









  
  
  
    
  


  


  


  






  





  <title>Excel数据导入导出 - Nop</title>


  <meta property="og:title" content="Excel数据导入导出">


  <meta name="description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">
  <meta property="og:description" content="Nop Platform 2.0 是基于可逆计算原理从零开始构建的新一代低代码平台，它致力于克服低代码平台无法摆脱穷举法的困境，从理论层面超越组件技术，有效的解决粗粒度软件复用的问题。">



  
    
  


  <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程">


<!-- 页面渲染兼容性 -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- 订阅 -->

<meta name="theme-color" content="#0871ab">
<link rel="shortcut icon" href="/images/nop/logo.png">


    
<link rel="stylesheet" href="/stylesheets/global.css">

    
<link rel="stylesheet" href="/stylesheets/ksio/vendors/share.css">

<link rel="stylesheet" href="/local/syntax-highlighting.css">

<link rel="stylesheet" href="/stylesheets/pages/post.css">

<link rel="stylesheet" href="/stylesheets/pages/doc.css">

    
      
  
    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = '//hm.baidu.com/hm.js?f8ce4b3ea0ca58886cf92248c093c7d9';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
    
  


    
    
<script src="/javascripts/ksio/vendors/jquery-1.11.3.min.js"></script>

    
<script src="/javascripts/ksio/vendors/bootstrap.min.js"></script>

  </head>
  
  
  <body class="Page" itemscope itemtype="http://schema.org/WebPage">
    

  <header class="Page-header">
  <div class="navbar navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        
          <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse">
            <span class="sr-only">Toggle navs</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        
        
          


  <a class="navbar-brand" href="/">Nop</a>


        
      </div>
      <!-- Nav menus -->
      <nav class="Page-navs navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          
  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy/docs">指南</a>
</li>
  

  
    <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">文章</a>
</li>
  

  
    <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">视频</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/projects/nop-entropy">Nop Entropy</a>
</li>
  

  
    <li><a href="/projects/nop-chaos">Nop Chaos</a>
</li>
  

</ul>
    </li>
  

  
    <li class="dropdown">
      <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a>
      <ul class="dropdown-menu">
  
    <li><a href="/community">社区</a>
</li>
  

  
    <li><a href="/team">团队</a>
</li>
  

  
    <li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">Gitee 组织</a>
</li>
  

</ul>
    </li>
  

  
    <li><a href="https://nop-platform.github.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-header" target="_blank" rel="external nofollow">English</a>
</li>
  


        </ul>
      </nav>
    </div>
  </div>
</header>

<div class="Page-content">
  
  
    <aside class="Page-aside">
      <div class="AsideBrand">


  <a href="/">Nop</a>

</div>
      <nav class="AsideNav"><ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/why-nop/">介绍</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
        
        <a href="/projects/nop-entropy/docs/">文档概览</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">极简服务层开发</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">极简数据访问层开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/">软件架构</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/theory/">理论基础</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a>
      
      
    </li>
  
</ul>

      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a>
      
      
        <ul>
  
  
    
  
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a>
      
      
    </li>
  
    <li>
      
      
      
      
      
        
        
        
        
          
          
        
        <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a>
      
      
    </li>
  
</ul>

      
    </li>
  
</ul>
</nav>
    </aside>
  
  <main class="Page-main">
    <article class="Article container-fluid">
      <header class="Article-header">
        
  
    <h1 class="Article-title">Excel数据导入导出</h1>
  
  


      </header>
      <div class="Article-content col-md-9"><p>在Nop平台中只需要增加imp.xml导入模型即可实现对存储在Excel中的复杂业务对象的解析，具体imp模型的定义参见<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/excel/imp.xdef">imp.xdef</a></p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><ul>
<li>对于普通字段，按照左侧是label，右侧是值来解析</li>
<li>对于列表字段，可以按照上面是label，下方是列表来解析</li>
<li>列表的第一列必须是数字列，不要求编号唯一，也不要求编号列在字段列表中定义。它仅仅被用于确定列表行的范围。</li>
<li>关键是在整体结构上能够明确的识别出父子关系。父字段必须覆盖子字段的范围。这样才能实现自动解析。</li>
<li>label可以对应于field的displayName或者name，两者都可以</li>
<li>字段的前后顺序不影响解析。在imp.xml中定义的field是全集，实际的模板中可以只使用部分字段。</li>
<li>但是标记为mandatory的字段必须在模板中存在，否则解析后发现对应字段值为空，会抛出异常。</li>
</ul>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><h2 id="如果解析列表"><a href="#如果解析列表" class="headerlink" title="如果解析列表"></a>如果解析列表</h2><ul>
<li>sheet或者field上标注list&#x3D;true，表示将会解析得到一个列表</li>
<li>列表的第一列必须是数字列，不要求编号唯一，也不要求编号列在字段列表中定义。它仅仅被用于确定列表行的范围。</li>
</ul>
<h2 id="如何解析一组sheet得到一个值"><a href="#如何解析一组sheet得到一个值" class="headerlink" title="如何解析一组sheet得到一个值"></a>如何解析一组sheet得到一个值</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sheet</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ss&quot;</span> <span class="hljs-attr">namePattern</span>=<span class="hljs-string">&quot;.*&quot;</span> <span class="hljs-attr">multiple</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">multipleAsMap</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">field</span>=<span class="hljs-string">&quot;ss&quot;</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">sheet</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>namePattern指定一个正则表达式，它描述如何匹配对应的sheet</li>
<li>multiple&#x3D;true表示会匹配到多个sheet</li>
<li>multipleAsMap&#x3D;true表示匹配到的多个sheet解析后，会按照sheetName汇总成一个Map。如果不指定这个属性或者设置为false，则多个sheet的解析结果会合并为一个List</li>
</ul>
<h2 id="使用导入模板来实现导出"><a href="#使用导入模板来实现导出" class="headerlink" title="使用导入模板来实现导出"></a>使用导入模板来实现导出</h2><ol>
<li>首先制作一个空的导入模板，即把导入数据删除，保留列表数据的序号列。具体样例参考<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-orm-model/src/main/resources/_vfs/nop/orm/imp/template.orm.xlsx">template.orm.xlsx</a></li>
<li>在imp.xml文件中通过templatePath属性来指向导入模板</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">imp</span> <span class="hljs-attr">x:schema</span>=<span class="hljs-string">&quot;/nop/schema/excel/imp.xdef&quot;</span> <span class="hljs-attr">xmlns:x</span>=<span class="hljs-string">&quot;/nop/schema/xdsl.xdef&quot;</span> <span class="hljs-attr">xmlns:c</span>=<span class="hljs-string">&quot;c&quot;</span> <span class="hljs-attr">xmlns:xpt</span>=<span class="hljs-string">&quot;xpt&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">templatePath</span>=<span class="hljs-string">&quot;template.orm.xlsx&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">imp</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>ExcelReportHelper中提供了根据导入的业务数据自动生成html或者xlsx文件的方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Object</span> bean = <span class="hljs-title class_">ExcelHelper</span>.<span class="hljs-title function_">loadXlsxObject</span>(<span class="hljs-string">&quot;/nop/test/imp/test5.imp.xml&quot;</span>, resource);    <br><span class="hljs-title class_">String</span> html = <span class="hljs-title class_">ExcelReportHelper</span>.<span class="hljs-title function_">getHtmlForXlsxObject</span>(impModelPath, bean, scope);<br><span class="hljs-title class_">ExcelReportHelper</span>.<span class="hljs-title function_">saveXlsxObject</span>(impModelPath, resource, bean);<br></code></pre></td></tr></table></figure>

<p>在imp模型的帮助下，Excel可以被看作是Java对象的一种序列化形式，类似于JSON和Java对象之间的自动双向转换，我们可以实现Excel和Java对象之间的自动双向转换。</p>
<p>具体示例参见<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/test/java/io/nop/biz/impl/TestImportExcelModel.java">TestImportExcelModel.java</a></p>
<h2 id="动态确定需要导入的列"><a href="#动态确定需要导入的列" class="headerlink" title="动态确定需要导入的列"></a>动态确定需要导入的列</h2><p>示例配置<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/test/resources/_vfs/nop/test/imp/test3.imp.xml">test3.imp.xml</a>,<br>测试用例<a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/test/java/io/nop/biz/impl/TestParseTreeTable.java">TestParseTreeTable.java</a></p>
<p>通过fieldDecider可以动态确定数据列所对应的解析配置。例如 2002指标、2003指标等列是动态变化的，我们希望解析这些列并把它们转换为一个列表属性。<br><img src="/knosys/project-nop-entropy/dev-guide/report/excel-import/import-dynamic-col.png"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;columns&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;项目指标&quot;</span> <span class="hljs-attr">list</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fields</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;指标&quot;</span> <span class="hljs-attr">mandatory</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;indexValue&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;X年指标&quot;</span> <span class="hljs-attr">virtual</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">stdDomain</span>=<span class="hljs-string">&quot;int&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">valueExpr</span>&gt;</span><br>                // 如果是第一次访问indexValues属性，则自动创建一个List<br>                let list = record.makeList(&#x27;indexValues&#x27;)<br>                let year = fieldLabel.$removeTail(&#x27;指标&#x27;).$toInt()<br>                list.add(&#123; year, value&#125;)<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">valueExpr</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 外部传入的年份列表数据 --&gt;</span><br>                indexYears<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- 根据展开表达式值动态构建字段标题 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelValueExpr</span>&gt;</span><br>                cell.ev + &#x27;指标&#x27;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelValueExpr</span>&gt;</span><br><br>            <span class="hljs-tag">&lt;<span class="hljs-name">xpt:valueExpr</span>&gt;</span><br>                _.findWhere(cell.rp.ev.indexValues,&#x27;year&#x27;,cell.cp.ev.$toInt()).value<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:valueExpr</span>&gt;</span>            <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">fields</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 如果字段标签以指标为后缀，则执行名称为indexValue的解析规则 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fieldDecider</span>&gt;</span><br>        fieldLabel.endsWith(&quot;指标&quot;) ? &quot;indexValue&quot; : null<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">fieldDecider</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>virtual&#x3D;true表示是虚拟字段。导入时只会执行字段的valueExpr，但并不会把返回的value设置到record的属性上。</li>
<li>在valueExpr执行的时候可以通过fieldLabel来引用字段的标题，通过value引用从单元格中解析得到的值，通过cell引用当前单元格</li>
<li>xpt:labelExpandExpr等以<code>xpt:</code>为前缀的标签在数据导出的时候使用。xpt:labelExpandExpr用于动态生成表格列</li>
<li>xpt:valueExpr返回动态生成的列所对应的单元格的值。cell.rp.ev相当于 cell.rowParent.expandValue用于获取行父格的展开值，而<br>cell.cp.ev对应于cell.colParent.expandValue，用于获取列的展开值。_.findWhere根据行父格和列父格的值，动态查找得到当前单元格对应的值。</li>
</ul>
<h2 id="动态设置单元格样式"><a href="#动态设置单元格样式" class="headerlink" title="动态设置单元格样式"></a>动态设置单元格样式</h2><p>导出数据的时候可以增加动态样式：当单元格的值满足某些条件的时候采用指定的样式来显示。例如当单元格的值大于300的时候，将单元格背景设置为红色。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">field</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelStyleIdExpr</span>&gt;</span><br>        cell.ev == 2002 ? &#x27;red&#x27; : null<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelStyleIdExpr</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xpt:styleIdExpr</span>&gt;</span><br>        cell.value &gt; 300 ? &#x27;red&#x27; : null<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:styleIdExpr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在数据模板中需要增加XptWorkbookModel这个Sheet页，在其中定义命名样式。<br><img src="/knosys/project-nop-entropy/dev-guide/report/excel-import/named-styles.png"></p>
<p>实际导出的结果为<br><img src="/knosys/project-nop-entropy/dev-guide/report/excel-import/export-with-style.png"></p>
<h2 id="支持复合表头"><a href="#支持复合表头" class="headerlink" title="支持复合表头"></a>支持复合表头</h2><p>导入数据的时候可以支持多级表头（目前只支持两级）<br><img src="/knosys/project-nop-entropy/dev-guide/report/excel-import/template-group-header.png"></p>
<p>导出结果为<br><img src="/knosys/project-nop-entropy/dev-guide/report/excel-import/group-header-export.png"></p>
<p>在imp.xml导入模型中进行配置时，只考虑匹配最下层的字段，分组字段不会直接参与匹配。</p>
<p>在field配置上增加groupField配置，它对应于另一个field配置，在其中可以配置<code>xpt:labelExpandExpr</code>等导出配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">fields</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;indexValue&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;X年&quot;</span> <span class="hljs-attr">virtual</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">groupField</span>=<span class="hljs-string">&quot;group&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">stdDomain</span>=<span class="hljs-string">&quot;int&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">valueExpr</span>&gt;</span><br>            // 如果是第一次访问indexValues属性，则自动创建一个List<br>            let list = record.makeList(&#x27;indexValues&#x27;)<br>            let year = fieldLabel.$removeTail(&#x27;年&#x27;).$toInt()<br>            let group = labelData.groupLabel<br>            list.add(&#123; year, value,group&#125;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">valueExpr</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 外部传入的年份列表数据。也可以通过cell.cp.ev来访问分组单元格的值 --&gt;</span><br>            indexYears<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 根据展开表达式值动态构建字段标题 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelValueExpr</span>&gt;</span><br>            cell.ev + &#x27;年&#x27;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelValueExpr</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- xpt:valueExpr是导出时执行的，而valueExpr是导入时执行的。因为执行时机不同，它们的上下文环境中</span><br><span class="hljs-comment">        可访问的变量也不同。导出时主要是cell和xptRt，也就是NopReport中的变量。而导入时是record, cell, fieldLabel等，</span><br><span class="hljs-comment">        此时没有rowParent和colParent等概念。</span><br><span class="hljs-comment">        --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:valueExpr</span>&gt;</span><br>            // cell.cp.cp表示取当前单元格的列父格的列父格。<br>            // cp是colParent的缩写。当前单元格的列父格就是动态展开的列的label所在的单元格。label单元格的父格就是分组单元格<br>            _.findWhere(cell.rp.ev.indexValues,&#123; year: cell.cp.ev.$toInt(), group: cell.cp.cp.value&#125;)?.value<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:valueExpr</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelStyleIdExpr</span>&gt;</span><br>            cell.ev == 2002 ? &#x27;red&#x27; : null<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelStyleIdExpr</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:styleIdExpr</span>&gt;</span><br>            cell.value &gt; 300 ? &#x27;red&#x27; : null<br>            <span class="hljs-comment">&lt;!--cell.value == &#x27;A2&#x27; ? &#x27;red&#x27; : null--&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:styleIdExpr</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    indexValue字段的groupField属性指向这个分组字段。这里主要是引入labelExpandExpr配置，也就是导出报表时的一些相关配置</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;group&quot;</span> <span class="hljs-attr">displayName</span>=<span class="hljs-string">&quot;group&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">schema</span> <span class="hljs-attr">stdDomain</span>=<span class="hljs-string">&quot;string&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br>            groups<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">xpt:labelExpandExpr</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">fields</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在导入具体数据单元格的时候，可以通过labelData变量（LabelData类型）访问到对应的labelCell和groupCell, 以及对应的field配置等。</p>
<h2 id="与Spring框架集成"><a href="#与Spring框架集成" class="headerlink" title="与Spring框架集成"></a>与Spring框架集成</h2><p>如果要使用Nop平台的Excel导入导出功能，只需要在pom文件中引入如下模块</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">        <span class="hljs-comment">&lt;!-- 实现Nop平台与spring框架的集成，不依赖于数据库，不依赖Web环境 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.entropy-cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>nop-spring-core-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- Excel解析和报表引擎支持 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.entropy-cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>nop-report-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>具体示例项目参见 <a target="_blank" rel="noopener" href="https://gitee.com/canonical-entropy/nop-entropy/tree/master/nop-demo/nop-spring-report-demo">nop-spring-report-demo</a></p>

</div>
      <footer class="Article-footer col-md-3">
        
          
          
          
          
            
          
          
            <div class="Widget">
              <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/report/excel-import.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div>
            </div>
          
        
        
  

  <section class="Widget Widget--toc">
  <div class="Widget-header">
    <h2 class="Widget-title">目录</h2>
  </div>
  <div class="Widget-body"></div>
</section>



      </footer>
    </article>
    <footer class="Page-footer Footer">
  <div class="container-fluid">
    
    <div class="Footer-description">
      
        <!-- Important links -->
        <nav class="Footer-navs">
          <ul><li><a href="/projects/nop-entropy/docs"><span>指南</span></a>
</li><li><a href="/community"><span>社区</span></a>
</li></ul>
        </nav>
      
      
        <!-- Copyright -->
        <div class="Footer-copyright">
          <p>

&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&amp;utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有

</p>
          
          
        </div>
      
    </div>
  </div>
</footer>

  </main>
</div>




    <script>$('.Article-content > table').addClass('table table-bordered')</script>
    
<script src="/javascripts/ksio/vendors/share.min.js"></script>

<script src="/javascripts/ksio/components/page.js"></script>

<script src="/javascripts/ksio/components/toc.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.js"></script>

<script src="/javascripts/ksio/vendors/jquery.timeago.zh-CN.js"></script>

<script src="/javascripts/ksio/initializers/time.js"></script>

<script src="/javascripts/ksio/vendors/jquery.lazyload.js"></script>

<script src="/javascripts/ksio/initializers/lazyload.js"></script>

  </body>
</html>

